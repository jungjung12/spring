<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardMapper">
   <sql id="selectBoard">
      SELECT
            BOARD_NO boardNo,
            BOARD_TITLE boardTitle,
            BOARD_WRITER boardWriter,
            BOARD_CONTENT boardContent,
            COUNT count,
            CREATE_DATE createDate,
            ORIGIN_NAME originName,
            CHANGE_NAME changeName
   </sql>




   <select id="boardCount" resultType="_int">
      SELECT
            COUNT(BOARD_NO)
        FROM
              BOARD
       WHERE
             STATUS = 'Y'
   </select>
   <select id="findAll" resultType="board" parameterType="map">
      <include refid="selectBoard"/>
      FROM
            (
            SELECT
                    BOARD_NO,
                    BOARD_TITLE,
                    BOARD_WRITER,
                    BOARD_CONTENT,
                    COUNT,
                    CREATE_DATE,
                    ORIGIN_NAME,
                    CHANGE_NAME,
                    ROWNUM RNUM
              FROM
                    (SELECT
                            BOARD_NO,
                            BOARD_TITLE,
                            BOARD_WRITER,
                            BOARD_CONTENT,
                            COUNT,
                            CREATE_DATE,
                            ORIGIN_NAME,
                            CHANGE_NAME
                      FROM
                            BOARD
                     WHERE
                            STATUS = 'Y'
                     ORDER
                        BY
                            BOARD_NO DESC)
            )
      WHERE 
             RNUM BETWEEN #{startValue} AND #{endValue}
   </select>
   
   <!-- 검색 시 반환 행 개수 -->
   <select id="searchCount" parameterType="hashmap" resultType="_int">
   SELECT
             COUNT(BOARD_NO)
       FROM
             BOARD
     WHERE
           STATUS='Y'
           <if test="condition == 'title'">
           AND
              BOARD_TITLE
           </if>
           <if test="condition == 'content'">
           AND
              BOARD_CONTENT
           </if>
           <if test="condition == 'writer'">
           AND
              BOARD_WRITER
           </if>
           LIKE '%' || #{keyword} || '%'
   </select>
   
   <select id="findByConditionAndKeyword" parameterType="hashmap" resultType="board">
      <include refid="selectBoard"/>
         FROM
               BOARD
       WHERE
              STATUS='Y'
          
      <choose>
            <when test="condition == 'title'">
               AND
                 BOARD_TITLE
            </when>
            <when test="condition == 'content'">
               AND
                 BOARD_CONTENT
            </when>
            <otherwise>
               AND
              BOARD_WRITER
            </otherwise>
      </choose>          
              LIKE '%' || #{keyword} || '%'
      ORDER
           BY
                 BOARD_NO DESC
   </select>
  
	<insert id="insert" parameterType="board">
	    INSERT INTO BOARD (
	        BOARD_NO,
	        BOARD_TITLE,
	        BOARD_WRITER,
	        BOARD_CONTENT,
	        ORIGIN_NAME,
	        CHANGE_NAME
	    )
	    VALUES (
	        SEQ_BNO.NEXTVAL,
	        #{boardTitle},
	        #{boardWriter},
	        #{boardContent},
	        #{originName},
	        #{changeName}
	    )
	</insert>
	
	<update id="increaseCount" parameterType="_int">
		UPDATE
			  BOARD
		   SET
		   	  COUNT = COUNT + 1
		 WHERE
		 	  BOARD_NO = #{boardNo}
		   AND
		   	  STATUS = 'Y'
	</update>
	
	<select id="findById" parameterType="_int" resultType="board">
	<include refid="selectBoard" />
	  	  FROM
	  	  	  BOARD
		 WHERE
		 	  BOARD_NO = #{boardNo}
	</select>
	
	<update id="delete">
		UPDATE
			  BOARD
		   SET
		   	  STATUS = 'N'
		 WHERE
		 	  BOARD_NO = #{boardNo}
	</update>
	
	<update id="update" parameterType="board">
		UPDATE
			  BOARD
		  SET
		  	  BOARD_TITLE = #{boardTitle},
		  	  BOARD_CONTENT = #{boardContent},
		  	  ORIGIN_NAME = #{originName},
		  	  CHANGE_NAME = #{changeName}
		 WHERE
		 	  BOARD_NO = #{boardNo}
	</update>
	
	<select id="selectImages" resultType="board">
	  SELECT
            CHANGE_NAME changeName,
            BOARD_TITLE boardTitle,
            USER_NAME boardWriter,
            BOARD_CONTENT boardContent,
            CREATE_DATE createDate
       FROM
            BOARD, MEMBER
      WHERE
            BOARD.BOARD_WRITER = MEMBER.USER_ID
        AND
            CHANGE_NAME IS NOT NULL
        AND
        	BOARD.STATUS = 'Y'
      ORDER
         BY
            BOARD_NO DESC
	</select>
	
	<select id="selectReply" parameterType="_int" resultType="reply">
		SELECT
			  REPLY_NO replyNo,
			  REPLY_CONTENT replyContent,
			  REPLY_WRITER replyWriter,
			  TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "createDate"
		  FROM
		  	  REPLY
		WHERE
			  STATUS = 'Y'
		  AND
		  	  REF_BNO = #{boardNo}
		 ORDER
		    BY
		      CREATE_DATE DESC
	
	</select>
	
	<insert id="saveReply" parameterType="reply">
		INSERT 
         INTO
               REPLY
               (
               REPLY_NO,
               REPLY_CONTENT,
               REPLY_WRITER,
               REF_BNO
               )
        VALUES
              (
              SEQ_RNO.NEXTVAL,
              #{replyContent},
              #{replyWriter},
              #{refBoardNo}
              )
	</insert>
	
</mapper>